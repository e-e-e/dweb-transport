<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Decentralized Web Boot loader</title>
    <base href="https://dweb.me/examples/bootloader.html"><!-- Allow relative URLs here, this could also be http://ipfs.io/ipfs/Q11...-->
    <script src="./dweb_transport_ipfs_bundled.js" type="text/javascript"></script>
    <script type="text/javascript" src="./htmlutils.js"></script><!--Login tools (used for p_connect) -->
    <script type="text/javascript" src="./loginutils.js"></script><!--Login tools (used for p_connect) -->
    <link rel='stylesheet' href='./example_styles.css'><!--TODO-BOOTSTRAP strip down to just what needed-->

</head>
<body>
<p>The decentralized web is everywhere, but we have to find it.</p>
<p>Loading ....</p>
<script>
    async function main(url) {
        let name;
        if (url.hostname.startsWith("dweb.")) {                                 // e.g. https://dweb.archive.org/details/commute
            name = ["arc/", url.hostname.substring(5), url.pathname].join("");   // arc/archive.org/details/commute
        } else if ( url.pathname.startsWith("/archive.org")) {                     // e.g. https://localhost:4244/archive.org/detais/commu
            name = ["arc",url.pathname].join("");                               // arc/archive.org/details/commute
        } else {
            console.error("Unable to bootstrap",url.href, "unrecognized pattern");
            document.write("Unable to bootstrap ",url.href, " unrecognized pattern");
            return;
        }
        console.log("Name to lookup=",name);
        document.write("Resolving name: ",name,"<BR>");   // Appears after loading
        document.write("Connecting to decentralized transports","<BR>");
        document.write('<div><ul id="transportstatuses"><li class="template vertical_li" onclick="transportclick(this);"><span name="name"></span></li></ul></div>');
        await p_connect();
        // This is our root - not necessarily a global one,
        rootpublicurls = [ 'ipfs:/ipfs/zdpuAp5dg6LphYwebkqGqqebhgLgxW26VAxe76k68D7dVa1oa',
            'contenthash:/contenthash/QmPxMb15iFcCiCnx6oWu6JJdNnwiqNkb5PVoAjbMBCAWLA' ];
        Dweb.Domain.root = await Dweb.SmartDict.p_fetch(rootpublicurls);
            /*
            fullname: "",   // Root is "" so that [fullname,name].join('/' is consistent for next level.
            keys: [],
            signatures: [],    // TODO-NAME Root record itself needs signing - but by who (maybe /arc etc)
            expires: undefined,
            _acl: kc,
            _map: undefined,   // May need to define this as an empty KVT
        }, true, {passphrase: pass+"/"}, verbose);   //TODO-NAME will need a secure root key
        */

        //TODO-BOOSTRAP - remove next couple of lines test
        //res = await Dweb.Domain.root.p_resolve("arc/archive.org/metadata/commute", {verbose});
        //console.log("Just checked resolves ok",res);
        try {
            let res = await Dweb.Domain.root.p_resolve(name, {verbose});
            let resolution = res[0];
            let remainder = res[1];
            opentarget="_self"; //TODO-BOOTSTRAP Use "_blank" when testing "_self" normally
            if ((resolution instanceof Dweb.Name) && ["text/html"].includes(resolution.mimetype)) {
                //Its an HTML file, open it (TODO-BOOTSTRAP see iterations in google doc)
                if (resolution.metadata.htmlusesrelativeurls) {
                    let tempurls = resolution.urls;
                    let pathatt = resolution.metadata.htmlpath || "path";
                    while (tempurls.length) {
                        url = new URL(tempurls.shift())
                        try {
                            url.search = url.search + (url.search ? '&' : "") + `${pathatt}=${remainder}`;
                            if (verbose) console.log("Bootstrap loading url:", url.href);
                            window.open(url.href, opentarget); //if opentarget is blank then I think should end this script.
                            break; // Only try and open one
                        } catch(err) {
                            console.error("Unable to load ",url.href)
                        }
                    }
                } else {
                    //TODO-BOOTSTRAP Not clear if parms make sense to a blob, if so can copy from above
                    display_blob(await Dweb.Transportable.p_fetch(resolution.urls, verbose), {type: resolution.mimetype, target: opentarget});
                }
            }
        } catch(err) {
            console.error("Got error",err);
        }
    }
    // Next few lines need explaining!  If passed an extra parameter url= then it will use that as the URL instead of ...bootloader.html
    // This is only useful until we have the server returning this file for anything under dweb.archive.org
    var searchparams = new URL(window.location.href).searchParams;  // Original parameters, which includes url if faking
    var verbose = searchparams.get("verbose");
    url = new URL(searchparams.get("url") || window.location.href);
    main(url);
</script>
</body>
</html>
