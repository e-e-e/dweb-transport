<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dweb example - Naming</title>
    <link rel='stylesheet' href='example_styles.css'>
    <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Roboto'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><!--briefcase etc-->
    <script type="text/javascript" src="dweb_bundled.js"></script><!-- Load bundle - assigns to "Dweb"-->
    <script type="text/javascript" src="htmlutils.js"></script><!--Non Dweb specific utility functions for working with HTML-->
    <script type="text/javascript" src="loginutils.js"></script><!--Dweb login functions, useful in multiple places-->
    <script type="text/javascript">

        //---------- Could move these to a library -----------
        // This comes from archive/ReactFake.js
        function createElement(tag, attrs, children) {        // Note arguments is set to tag, attrs, child1, child2 etc
            /* Replaces React's createElement - has a number of application specific special cases
                <img src=ArchiveFile(...)> replaced by <div><img x-=u>

             */

            /* First we handle cases where we dont actually build the tag requested */

            const kids = Array.prototype.slice.call(arguments).slice(2);

            /* Special cases go here - see examples in archive/ReactFake.js---- */
            return buildoutElement(document.createElement(tag), tag, attrs, kids);
        }
        function buildoutElement(element, tag, attrs, kids) {
            /* Build out a created element adding Attributes and Children
            tag:    Lower case string of element e.g. "img"
            attrs:  Object {attr: value}
            kids:   Array of children
            /* This is called back by loadImg after creating the tag. */
            for (let name in attrs) {
                const attrname = (name.toLowerCase() === "classname" ? "class" : name); // support Reacts "classname"
                if (name === "dangerouslySetInnerHTML") {
                    element.innerHTML = attrs[name]["__html"];
                    delete attrs.dangerouslySetInnerHTML;
                }
                /*
                // Turn relative URLS in IMG and A into absolute urls - ideally these are also caught by special cases
                if (["img.src", "a.href"].includes(tag + "." + name) && (typeof attrs[name] === "string") && attrs[name].startsWith('/')) {
                    if (!React._config.root) console.error("Need to React.config({root: 'https://xyz.abc'");
                    attrs[name] = React._config.root + attrs[name];  // e.g. /foo => https://bar.com/foo
                }
                */
                /* Special cases go here - see examples in archive/ReactFake.js---- */
                if (name && attrs.hasOwnProperty(name)) {
                    let value = attrs[name];
                    if (value === true) {
                        element.setAttribute(attrname, name);
                    } else if (typeof value === "object" && !Array.isArray(value) && attrname !== "source") {
                        // Could also test value.__proto__ !== ({}).__proto__ to only allow plain (not subclassed) objects
                        // e.g. style: {{fontSize: "124px"}} but not things like Domains or SmartDicts
                        for (let k in value) {
                            element[attrname][k] = value[k];
                        }
                    } else if (typeof value === "object" && !Array.isArray(value) && attrname === "source") {
                        element[attrname] = attrs[name]; // Cant use setAttribute to set a non-attribute to an object.
                    } else if (value !== false && value != null) {
                        element.setAttribute(attrname, value.toString());
                    }
                }
            }
            for (let i = 0; i < kids.length; i++) {
                const child = kids[i];
                if (!child) {
                } else if (Array.isArray(child)) {
                    child.map((c) => element.appendChild(c.nodeType == null ?
                        document.createTextNode(c.toString()) : c))
                }
                else {
                    element.appendChild(
                        child.nodeType == null ?
                            document.createTextNode(child.toString()) : child);
                }
            }
            return element;
        }

        //-----------------End of candidates for library ----


        async function onlogin(kc) {
            alert(`${kc.name} just logged in`)
            //TODO-NAMING adjust permissions, locks etc
        }
        async function domain_open(el_li, el_ul, dom) {
            // el is the li, want the ui inside it
            if (el_li.classList.contains("collapsed")) {
                let kids = await dom.p_getall();
                el_li.classList.remove("collapsed");
                el_li.classList.add("expanded");
                el_li.classList.remove("fa-folder");
                el_li.classList.add("fa-folder-open");
                for (let k of Object.keys(kids)) {
                    addsubdomain(el_ul, k, kids[k]);
                }
            } else if (el_li.classList.contains("expanded")) {
                el_li.classList.remove("expanded");
                el_li.classList.add("collapsed");
                el_li.classList.remove("fa-folder-open");
                el_li.classList.add("fa-folder");
                while (el_ul.lastChild)  el_ul.removeChild(el_ul.lastChild);
            }
            // If neither then dont open or close it - TODO-NAMING maybe navigate to it ?
        }
        async function domain_close() {
            alert("domain_close")
        }
        async function show_details(el_details, dom) {
            deletechildren(el_details, true);
            addtemplatedchild(el_details, {templatename: dom.table}, dom, {metadatajson: JSON.stringify(dom.metadata)});
        }
        function addsubdomain(el, name, dom) {
            // el should be a ul to add newly created nodes to
            let el_name = createElement("span", {class: "naming_name"}, name);
            let el_ul = createElement("ul", {});
            fa_icon = {"domain": "fa-folder", "leaf": "fa-leaf"}[dom.table] || "fa_question";
            expandable = ["domain"].includes(dom.table);
            let el_li = createElement("li", {class: `${ expandable ? "collapsed " : " "}fa ${fa_icon}`, source: dom },
                //createElement("img", {class: "tree_icon ", src: `images/tree_${dom.table}`} )
                el_name, el_ul);
            el_name.onclick = function(evt) {
                // Either of these seem to be sufficient but see both in some online examples
                if (evt.stopPropagation)    evt.stopPropagation();
                if (evt.cancelBubble!=null) evt.cancelBubble = true;
                show_details("naming_details", dom);
            };
            el_li.onclick = function(evt) {
                // Either of these seem to be sufficient but see both in some online examples
                // this will be the li
                if (evt.stopPropagation)    evt.stopPropagation();
                if (evt.cancelBubble!=null) evt.cancelBubble = true;
                let dom = this.source;
                domain_open(el_li, el_ul, dom);

            };
            el.appendChild(el_li);
        }
       async function main() {
            //This is the "main()", starts a transport, checks its status, and if appropriate to app opens a URL passed
            // These next two lines reqd at this level to get the global scope
            try {
                await p_connect(); // Default startup beavior from loginutils.js
                // Any code you want to run once online goes here.
                var url = searchparams.get("url"); // Unused in this example
                Dweb.KeyChain.eventHandler.addEventListener((event) => {   //TODO-EVENT move to new mechanism in PublicPrivate
                    console.log("event",event);
                    if (event.type === "login") {
                        // noinspection JSIgnoredPromiseFromCall
                        onlogin(event.values); }
                });
                await Dweb.Domain.p_rootSet({verbose});
                console.log("==Login should have finished-== output after here implies async issue ===");
                let el_root_ul = document.getElementById("treeroot_ul");
                addsubdomain(el_root_ul, "/", Dweb.Domain.root);
            } catch(err) { // Catch any uncaught errors here, log and alert.
                console.log("App Error:", err);
                throw(err);
                alert(err.message);
            }
        }

    </script>
    <style>
        .naming_outer { display: inline;}
        .naming_tree {display: inline-grid; background-color: #F0F8F0; vertical-align: top;}
        .naming_tree li { padding: 5px; display: list-item; list-style: none }
        .naming_tree ul { -webkit-padding-start: 15px;}
        .naming_name { background-color: #f0f0f0; padding-left: 5px; }
        .naming_details { background-color:#F0E8F0; display: inline-grid; vertical-align: top;}
        .tree_icon {height: 12px; margin-left: 12px; margin-right: 3px;}
        .naming_details ul { list-style: none; padding-left: 10px;}
        .naming_details li { padding-top: 1px; margin: 0 0 3px 3px;}
        .propname { display: inline-block; background-color: inherit; border: none; vertical-align: top; }
        .propval, .proplist {display: inline-block; background-color: inherit;}
        .proplist {padding-left: 0px;}
    </style>

</head>
<body class="examples example_naming">

<div class="naming_outer">
    <div class="naming_tree"><!--Tree-->
        <ul id="treeroot_ul">
        </ul>
    </div>
    <div class="naming_details" id="naming_details"><!--Details-->
        <ul class="template domain">
                <li><span class="propname">Full Name</span><span name="fullname" class="propval"></span></li>
                <li><span class="propname">Expires</span><span name="expires" class="propval"></span></li>
                <li><span class="propname">Keys</span><ul name="keys" class="proplist"><li class="template"><span name="_"></span></li></ul></li>
                <li><span class="propname">Signatures</span><ul name="signatures" class="proplist">
                    <li class="template"><span name="date"></span><br/><span name="signedby"></span><br/><span name="signature"></span></li></ul>
                <li><span class="propname">Tables</span><ul name="tablepublicurls" class="proplist"><li class="template"><span name="_"></span></li></ul></li>
        </ul>
        <ul class="template leaf">
            <li><span class="propname">Leaf Name</span><span name="fullname" class="propval"></span></li>
            <li><span class="propname">Expires</span><span name="expires" class="propval"></span></li>
            <li><span class="propname">Signatures</span><ul name="signatures" class="proplist">
                <li class="template"><span name="date"></span><br/><span name="signedby"></span><br/><span name="signature"></span></li></ul>
            <li><span class="propname">URLs</span><ul name="urls" class="proplist"><li class="template"><span name="_"></span></li></ul></li>
            <li><span class="propname">Mimetype</span>:&nbsp;<span name="mimetype" class="propval"></span></li>
            <li><span class="propname">Metadata</span>:&nbsp;<span name="metadatajson" class="propval"></span></li>
        </ul>
    </div>
</div>


<!--Login and network status box - this is standard for any app requiring logging in -- if edit, change on at least example_keys, example_versions -->
<div class="floatright" style="position:relative;">
    <ul id="transportstatuses"><li class='template vertical_li' onclick="transportclick(this);"><span name='name'></span></li></ul><!--TODO Add onclick to statuses-->
    <ul id="keychains_ul"><li class='template vertical_li' onclick='keychain_click(this);'><span name='name'></span></li></ul>
    <form><input id="logout" class="button" type="button" onclick="logout_click();" style="display:none;" value="Logout"/></form><!--logout all keychains-->
    <img src="noun_186903_cc.png" alt="keychain" class="iconopener" onclick="show('loginform','');"/>
    <form class="dialogform" id="loginform" onsubmit="loginformsubmit(); return false;" style="display:none;">
        <img class="keylist_icon" src="noun_83161_cc.svg" alt="Close" onclick="hide('loginform');"/>
        <input class="propval" type="text" name="name" size="20" placeholder="Your id"/>
        <input class="propval" type="text" name="passphrase" size="70" placeholder="Passphrase"/>
        <input class="button" type="submit" value="Login"/>
        <input class="button" type="button" onclick="show('registrationform');" value="Register"/>
    </form>
    <form class="dialogform" id="registrationform" name="registrationform" onsubmit="registrationsubmit(); return false;" style="display:none;">
        <img class="keylist_icon" src="noun_83161_cc.svg" alt="Close" onclick="hide('registrationform');"/>
        <input class="propval" type="text" name="name" size="50" placeholder="Your id - it doesnt have to be unique"/>
        <input class="propval" type="text" name="passphrase" size="70" placeholder="Type a complex phrase, easy for you to remember, hard for others to guess, mixed case, numbers, punctuation are all good"/>
        <input class="button" type="submit" value="Register"/>
    </form>
    <!-- KeyChain -->
    <div id="keychain" class="displayedblock" style="display:none;">
        <div class="displayedblockheader" id="keychain_header">
            <form class="dialogform">
                <img class="keylist_icon" src="noun_83161_cc.svg" alt="Close" onclick="hide('keychain');" style="float:right;"/>
                <span name="name" style="display: inline-block;"></span>
                <!--If change icons, see icon_images above-->
                <span style="display: inline-block;"><img class="keylist_icon" src="noun_1146472_cc.png" alt="Key"/><input class="button" type="button" onclick="show('keynew_form');" value="new key"/></span>
                <span style="display: inline-block;"><img class="keylist_icon" src="noun_1093404_cc.png" alt="Lock"/><input class="button" type="button" onclick="show('locknew_form');" value="new lock"/></span>
            </form>
        </div>
        <!-- List of all keys in keychain-->
        <ul id="keychain_ul" class="inline_ul">
            <li class="inline_li template" onclick="kcitem_click(this);"><img class="keylist_icon" name="objsym"/><span class="keylist_name" name="name"></span></li>';
        </ul>
    </div>
    <form id="keynew_form" name="keynew_form" onsubmit="keynew_click(); return false;" style="display:none">
        <input class="propval" type="text" name="name" size="50" placeholder="Name of the key"/>
        <input class="button" type="submit" value="Generate"/>
    </form>
    <form id="locknew_form" name="locknew_form" onsubmit="locknew_click(); return false;" style="display:none">
        <input class="propval" type="text" name="name" size="50" placeholder="Name of the Lock"/>
        <input class="button" type="submit" value="Generate"/>
    </form>
    <div id="lock_div" class="displayedblock" style="display:none">
        <div class="displayedblockheader" id="lock_header"><!--note source will be set on lock_header-->
            Lock: <img class="keylist_icon" src="noun_1176543_cc.png" onclick='locklink_click("lock_header");' alt="link"/><span name="name"></span>
            <form class="dialogform" style="display:inline-block;">
                <img class="keylist_icon" src="noun_708669_cc.png" alt="Key"/><input class="button" type="button" onclick="show('tokennew_form');" value="new token"/>
                <img class="keylist_icon" src="noun_83161_cc.svg" alt="Close" onclick="hide('lock_div');"/>
            </form>
        </div>
        <!-- List of all tokens in AccessControlList-->
        <ul id="lock_ul" class="inline_ul">
            <li class="inline_li template" onclick="kcitem_click(this)">
                <img class="keylist_icon" name="objsym" alt="key"/>
                <span class="keylist_name" name="name"></span>
            </li>
        </ul>
    </div>
    <!--Dialogue to enter a new key for an ACL -->
    <form id='tokennew_form' name="tokennew_form" onsubmit="tokennew_click(); return false;" style="display:none;">
        <input class="propval" type="text" name="name" size="20" placeholder="Name of key" style="align:right;" />
        <img class="keylist_icon" src="noun_83161_cc.svg" alt="Close" onclick="hide('tokennew_form');"/>
        <input class="propval" type="text" name="urls" size="50" placeholder="URLs of key"/><br/>
        <input class="button" type="submit" value="Add" style="align:right;"/>
    </form>
</div><!--End of standard network status and login panel-->


<h1>Dweb - Naming - Documentation</h1>
<p>This page is an example UI for display and registering names.</p>
<ul>
<li>For other examples see <a target="_blank" href="./index.html">index.html</a></li>
    <li>See <a target="_blank" href="./example_keys.html">example_keys</a> for documentation on login, keys etc</li>
    <li>See the
        <a target="_blank" href="https://docs.google.com/document/d/1PwU725r3Kuyu1ALoqOgmFUMlbM2Y8-IIFgMglN59XBM/edit#">google doc</a>
        describing this</li>
</ul>
<p>There are a few key concepts.</p>
    <ul>
    <li><strong>Domain:</strong> TODO-NAMING write this.</li>
    </ul>
<h3>Usage</h3>
<h4>Registration</h4>
<p>
    First step ...
</p>

<script type="text/javascript">
    // These have to be at global level so they can be found anywhere.
    var searchparams = new URL(window.location.href).searchParams;
    var verbose = searchparams.get("verbose") || false;  // Anything specified for verbose is true (could truthify buy no need)
    main();
</script>
</body>
</html>